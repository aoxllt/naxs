# 项目统一与剩余任务

本文档概述了当前状态、已验证的修复以及进一步项目统一、错误解决和改进的计划。

## 1. 已修复问题：Access Token 刷新失败 (Go 后端)

**描述：**
前端在尝试访问 `/api/v1/auth/refresh` 端点刷新 access token 时遇到 401 错误。Go 后端的 JWT 认证中间件 (`middleware.JWTAuth()`) 被错误地应用到了此刷新路由，导致 `RefreshController` 无法处理通过 HTTP-only Cookie 发送的 `refreshToken`。

**已应用修复：**
修改了 `backend/api/internal/gateway/router/router.go`，将 `/api/v1/auth/refresh` 路由移出 `JWTAuth` 保护组。这使得 `RefreshController` 可以按设计独立处理刷新令牌。

**验证步骤：**
为确认此修复，请遵循以下步骤：
1.  **重建并重启 Go 后端：** 确保 Go API 服务已使用最新更改运行。
    *   导航到 `E:\Project\naxs\backend\api`。
    *   运行 `go build -o cmd/app/app.exe cmd/app/main.go`（或您项目相应的构建命令）。
    *   运行 `cmd/app/app.exe`（或您项目相应的运行命令）。
2.  **启动前端：**
    *   导航到 `E:\Project\naxs\frontend`。
    *   运行 `npm install`（如果尚未安装依赖）。
    *   运行 `npm run dev`（或您项目相应的启动命令）。
3.  **执行初始登录：** 通过前端应用程序登录。
4.  **观察 Access Token 过期：** Access token 配置为 15 分钟过期（`config.yaml` 中 `auth.jwt.access_expire: "15m"`）。您可以等待 15 分钟，或者为了更快测试，手动清除前端内存中存储的 `accessToken`（例如，`auth.ts` 中的 `accessToken` 变量），而不触及 `refreshToken` cookie。
5.  **触发受保护的 API 请求：** 在 access token 过期（或被清除）后，尝试访问需要 JWT 保护的 Go 后端端点的前端功能（例如，`/api/v1/auth/profiles/avatar`）。
6.  **检查网络选项卡（浏览器开发者工具）：**
    *   您应该会观察到最初的受保护请求以 401 失败。
    *   紧接着，您应该会看到一个成功的 `POST` 请求到 `http://localhost:8080/api/v1/auth/refresh`。
    *   最后，前端会自动重试原始的受保护请求，并使用新获得的 access token 成功。
7.  **确认功能：** 应用程序应该能够继续运行，无需完全重新登录，这表明令牌刷新成功。

## 2. 待完成任务和项目统一

根据最初的请求和项目结构，以下是进一步统一项目、解决错误和改进的剩余任务和领域：

### 2.1. 后端架构澄清 (Go 与 Java)

*   **任务：** 明确定义 Go 后端（用户系统、网关功能）和 Java 后端（其他业务逻辑）之间的角色和交互机制。
*   **需要回答的问题：**
    *   这两个后端如何通信？（例如，直接 HTTP 调用、消息队列、共享数据库）
    *   是否存在一个中央 API 网关来协调对两者的请求？（Go 被描述为“网关功能”，因此很有可能）。
    *   认证在这两者之间如何处理？（例如，Java 后端是否信任 Go 颁发的 JWT，或者它有自己的认证机制？）
*   **文档：** 更新项目架构文档（例如，`backend/api` 中的 `ARCHITECTURE_EVOLUTION.md`），以反映这种清晰的分离和交互模型。

### 2.2. 全面错误处理和日志记录

*   **任务：** 调查并解决前端和后端服务中所有其他现有错误（编译时、运行时、逻辑错误）。
*   **待办事项：**
    *   **用户报告的错误：** 用户提供遇到的任何其他具体错误详情。
    *   **系统审查：** 为 Go 和 Java 服务实施全面的日志记录和监控。
    *   **错误标准化：** 确保所有 API（Go 和 Java）的错误响应格式一致（例如，包含 `code`、`message`、`details` 的 JSON 错误），以便前端更容易消费。
    *   **前端错误显示：** 增强前端以显示 API 故障的用户友好错误消息。

### 2.3. 项目构建和运行自动化

*   **任务：** 创建清晰、统一的指令，用于构建、运行和部署整个项目（前端、Go 后端、Java 后端）。
*   **待办事项：**
    *   **定义启动命令：** 记录启动每个服务（Go、Java、前端）的确切命令。
    *   **依赖管理：** 概述如何安装每个部分的依赖项（例如，`go mod tidy`、`gradle build`、`npm install`）。
    *   **配置管理：** 详细说明如何为每个环境（开发、测试、生产）提供必要的配置（数据库凭据、Redis、第三方 API 密钥）。
    *   **Docker 化：** 如果适用，创建 `docker-compose.yml` 来协调所有服务以进行本地开发/部署。

### 2.4. 测试策略

*   **任务：** 为整个项目建立并实施健全的测试策略。
*   **待办事项：**
    *   **单元测试：** 确保 Go 和 Java 中关键业务逻辑的足够单元测试覆盖率。
    *   **集成测试：** 编写集成测试以验证 Go 和 Java 服务之间以及前端和后端之间的通信。
    *   **端到端测试：** 实施端到端测试（例如，使用 Cypress、Playwright）以模拟用户流程并确保整体系统功能。

### 2.5. 代码质量和一致性

*   **任务：** 确保整个项目的代码质量、风格和结构保持一致。
*   **待办事项：**
    *   **Linting/格式化：** 设置并强制执行一致的 Linting 和代码格式化规则（例如，Go 的 `gofmt`，前端的 Prettier/ESLint，Java 的 Checkstyle/SpotBugs）。
    *   **命名约定：** 在所有部分中标准化变量、函数和文件的命名约定。
    *   **API 契约一致性：** 审查并标准化前端、Go 和 Java 之间的 API 端点命名、请求/响应结构和数据类型。

## 下一步行动：

请按照上述步骤验证令牌刷新修复。确认后，我们可以优先处理和解决剩余任务。
